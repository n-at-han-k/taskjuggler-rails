# 1. Bump version in lib/taskjuggler_rails/version.rb
# 2. Update CHANGELOG.md
#
#   git add .
#   git commit -m "Release v0.1.1"
# 
# 3. Create and push tag
#
#   git tag v0.1.1
#   git push origin main
#   git push origin v0.1.1   # this triggers the workflow
name: Release Gem

on:
  push:
    tags:
      - "v*"  # Triggers on tags like v0.1.0, v1.2.3, etc.

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write   # needed for trusted publishing (2025 best practice)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # important for correct version/tag detection

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'  # or whatever your gem supports
          bundler-cache: true

      - name: Build gem
        run: |
          gem build *.gemspec
          mkdir -p pkg
          mv *.gem pkg/

      - name: Publish to RubyGems
        run: |
          mkdir -p ~/.gem
          echo "---" > ~/.gem/credentials
          echo ":rubygems_api_key: ${{ secrets.RUBYGEMS_API_KEY }}" >> ~/.gem/credentials
          chmod 600 ~/.gem/credentials
          gem push pkg/*.gem
